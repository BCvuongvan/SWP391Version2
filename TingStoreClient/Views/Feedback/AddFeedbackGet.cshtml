@model IEnumerable<TingStoreClient.Models.Product>
@{
    ViewData["Title"] = "AddFeedbackGet";
}

<head>
    <title>Add Feedback</title>
    <!-- Thêm các tài nguyên CSS, JavaScript, và các tài nguyên khác cần thiết -->
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>

<body>
    <td>
        <a asp-action="AddNew" asp-controller="Feedback" class="btn btn-primary">Add Feedback</a>
    </td>
    <h2>Products Bought By User:</h2>

    <table>
        <tr>
            <th>Product ID</th>
            <th>Product Name</th>
            <th>Product Image</th>
        </tr>
        @foreach (var product in Model)
        {
            <tr>
                <td>@product.proId</td>
                <td>@product.proName</td>
                <td><img src="@product.proImage" alt="@product.proName" style="max-width: 100px; max-height: 100px;" /></td>
                <td>
                </td>
            </tr>
        }

    </table>

    <script>
        // Function to submit feedback
        async function submitFeedback() {
            try {
                const form = document.querySelector('form');
                const formData = new FormData(form);
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData
                });
                if (!response.ok) {
                    throw new Error('Failed to add feedback');
                }
                alert('Feedback added successfully!');
                return true;
            } catch (error) {
                console.error('Error:', error.message);
                return false;
            }
        }

        // Function to fetch products bought by the user from the API
        async function fetchProducts() {
            try {
                const userName = '@ViewBag.UserName'; // Get the username from ViewBag
                const response = await fetch(`https://localhost:5001/api/Feedback/products-bought/${userName}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }
                const products = await response.json();
                // Add products to the HTML table
                const productList = document.querySelector('table');
                products.forEach(product => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${product.proId}</td>
                        <td>${product.proName}</td>
                        <td><img src="${product.proImage}" alt="${product.proName}" style="max-width: 100px; max-height: 100px;" /></td>
                        <td>
                            <form asp-action="AddFeedback" asp-controller="Feedback" method="post" onsubmit="return submitFeedback()">
                                <input type="hidden" name="proId" value="${product.proId}" />
                            </form>
                        </td>
                    `;
                    productList.appendChild(tr);
                });
            } catch (error) {
                console.error('Error:', error.message);
            }
        }

        // Call fetchProducts function when the page loads
        window.onload = fetchProducts;
    </script>
</body>
